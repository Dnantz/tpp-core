
## Metasets

This document describes the idea of metaset.
The term "metaset" was chosen, because they describe groups of pokemon sets, and therefore are "sets of sets".
The specification of pokemon sets (short pokesets) can currently be found [at github.com/TwitchPlaysPokemon/pokecat](https://github.com/TwitchPlaysPokemon/pokecat/blob/master/pokesetspec.md).

### Rationale

During development and operation of TwitchPlaysPokemon,
the need to be able to address whole groups of pokesets by their properties,
and apply special rules to them, arised. Some properties might be inferred from the
pokemon's existing data, others might get manually added as "markings" by pokeset creators.

### Tagging and matching metasets

In order to be able to address whole groups of pokesets, each pokeset contains tags.
Some tags will be autogenerated based on the pokeset's data (e.g. `species+bulbasaur`),
but they can also be manually added by the pokeset creators.
Also see [the specification for tags in pokesets](https://github.com/TwitchPlaysPokemon/pokecat/blob/master/pokesetspec.md#obligatory-fields)

For best flexibility, describing how certain tags apply to a metaset _might_ be implemented
with a simple grammar consisting of logical operations of identifiers.
The identifiers would represent tags. Each tag would then get treated like a boolean,
where `true` means the presence and `false` the absence of a certain tag.
It might also be useful to be able to specify pokemon position, pokemon counts, and relations to the opponent.

Here's an example of how a very specific rule could be expressed in such a grammar: 
>either no stalling sets, or any side starts with a ghost-type pokemon and their opponent has at most 2 normal-type pokemon`

    !stall | (type+ghost[0] & ~type+normal{,2})

Which would have the grammar (Pseudo-BNF):

    (whitespace omitting implicit, precedence follows order)
    Ident    ::= following the regex '[a-Z_+-][a-Z0-9_+-]*'
    Tag      ::= [Prefix] Ident [Postfix]
    Prefix   ::= '~'
    Postfix  ::= Quantity | Position
    Quantity ::= '[' number ']'
    Position ::= '{' number [',' [number]] '}' | '{,' number '}'
    Not      ::= '!' Expr
    Group    ::= [Prefix] '(' Expr ')' [Postfix]
    And      ::= Expr '&' Expr
    Or       ::= Expr '|' Expr
    Expr     ::= Tag | Not | Group | And | Or

Though such high complexity might not be necessary.
What implementation gets chosen needs further evaluation.

### Possible usecases

- Apply an increased bidding cooldown to all RNG-heavy pokesets.
- Enforce switching to be always allowed if the tag `stall` is present.
- Be able to collaboratively bid on a "token"-metaset,
  and have it randomly choose pokemon with the `token` tag afterwards.
- Have a "little cup" game mode, which only allows level 5 pokemon.
- Hide all pokemon tagged as `hidden` from token bidding (is currently handled explicitly).
- Disable cancer- and balance-checks for certain pokemon.

### Metaset precedence

Metasets need to have a priority value assigned to them,
because a specific configuration might fit multiple sets.
In those cases, it needs to be decided whose metaset's properties should apply.
Consider the following diagram:

    |
    |                      property  1      property  2      property  3
    |                     +-----------+    +-----------+    +-----------+
    |    Effective set:   |    142    |    |    baz    |    |   false   |
    |                     +-----------+    +-----------+    +-----------+
    |                           |                |                |
    |                           |                |                |
    |                           |                |                |
    |                           v                |                |
    |                     +-----------+    +-----------+    +-----------+
    |  Set priority #1:   |    142    |    | <omitted> |    | <omitted> |
    |                     +-----------+    +-----------+    +-----------+
    |                                            |                |
    |                                            |                v
    |                     +-----------+    +-----------+    +-----------+
    |  Set priority #2:   |    420    |    | <omitted> |    |   false   |
    |                     +-----------+    +-----------+    +-----------+
    |                                            |
    |                                            v
    |                     +-----------+    +-----------+    +-----------+
    |         Defaults:   |    142    |    |    baz    |    | <omitted> |
    |                     +-----------+    +-----------+    +-----------+
    |

Note that therefore setting a property to its default value and omitting a property
altogether can have different results, which might be unintuitive at first.

Also note that even the defaults might omit values.
This can make sense for example if a metaset property is a restriction,
and no value being set implies not applying that restriction. 
